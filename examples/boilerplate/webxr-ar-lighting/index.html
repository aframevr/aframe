<html>

<head>
	<script src="../../../dist/aframe-master.js"></script>
	<script
		src="https://unpkg.com/aframe-environment-component@1.2.0/dist/aframe-environment-component.min.js"></script>
	<title>AFRame Total WebXR AR Demo</title>
	<style>
		body {
			font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
		}

		#dom-overlay {
			overflow: hidden;
			position: absolute;
			pointer-events: none;
			box-sizing: border-box;
			bottom: 0;
			left: 0;
			right: 0;
			top: 0;
			padding: 1em;
		}

		#dom-overlay>* {
			pointer-events: auto;
		}
	</style>

	<script>
		AFRAME.registerGeometry('shadow-plane', {
			schema: {
				width: { default: 5, min: 0 },
				height: { default: 5, min: 0 }
			},

			init: function (data) {
				this.geometry = new THREE.PlaneGeometry(data.width, data.height);
				this.geometry.rotateX(-Math.PI / 2);
			}
		});

		/**
		Component to hide the shadow whilst the user is using ar-hit-test because they tend to interact poorly
		*/
		AFRAME.registerComponent('ar-shadow-helper', {
			schema: {
				target: {
					type: 'selector',
				}
			},
			init: function () {
				var self = this;
				this.el.object3D.visible = false;

				this.el.sceneEl.addEventListener('enter-vr', function () {
					if (self.el.sceneEl.is('ar-mode')) {
						self.el.object3D.visible = self.data.startVisibleInAR;
					}
				});
				this.el.sceneEl.addEventListener('exit-vr', function () {
					self.el.object3D.visible = false;
				});

				this.el.sceneEl.addEventListener('ar-hit-test-select-start', function () {
					self.el.object3D.visible = false;
				});

				this.el.sceneEl.addEventListener('ar-hit-test-select', function () {
					self.el.object3D.visible = true;
				});
			},
			tick: function () {
				if (this.data.target) {
					this.el.object3D.position.copy(this.data.target.object3D.position);
					this.el.object3D.quaternion.copy(this.data.target.object3D.quaternion);
				}
			}
		});

	</script>
</head>

<body>
	<a-scene id="scene" webxr="optionalFeatures:hit-test,light-estimation,dom-overlay; overlayElement:#dom-overlay;"
		background="directionalLight:#dirlight;" ar-hit-test="target:#table;">
		<a-assets>
			<!-- model by Snooze https://sketchfab.com/3d-models/low-poly-table-b940256ec5994e26a9e71289d1211b19 -->
			<a-asset-item id="table-glb"
				src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c91156f58974db40fa9f542bb959fb73fe1970f/examples/assets/models/table.glb">
			</a-asset-item>
		</a-assets>

		<a-camera position="0 1.6 2"></a-camera>

		<a-light id="dirlight" intensity="0.5" light="castShadow:true;type:directional" position="1 1 1"></a-light>
		<a-light hide-on-enter-ar intensity="0.5" light="type:hemisphere;color:yellow;groundColor:blue;"
			position="1 1 1"></a-light>

		<a-entity hide-on-enter-ar environment="lighting:none;shadow:true;"></a-entity>

		<a-entity geometry="primitive:shadow-plane;" material="shader:shadow" shadow="cast:false"
			ar-shadow-helper="target:#table;"></a-entity>

		<a-entity hide-on-enter-ar id="table" shadow gltf-model="#table-glb" scale="0.7 0.7 0.7" position="0 0 0">
			<a-entity scale="0.3 0.3 0.3" position="0 1.05 0">
				<a-cylinder position="1 0.75 1" radius="0.5" height="1.5" color="#FFC65D"
					material="roughness: 0.1; metalness: 0.2;"></a-cylinder>
				<a-box position="-1 0.5 1" rotation="0 45 0" color="#4CC3D9" material="roughness: 0.1; metalness: 0.2;">
				</a-box>
				<a-sphere position="0 1.25 -1" radius="1.25" color="#FFFFFF" material="roughness: 0; metalness: 0;">
				</a-sphere>
				<a-torus-knot position="0 3 0" material="metalness: 1; roughness: 0.17"
					geometry="radius: 0.45; radiusTubular: 0.09"
					animation__rotate="easing: linear; from: 0 0 0; loop: true; property: rotation; to: 0 0 360; dur: 3000;">
				</a-torus-knot>
			</a-entity>
		</a-entity>
	</a-scene>
	<div id="dom-overlay">
		<h1>Hello World!</h1>
		<p id="dom-overlay-message"></p>
	</div>
	<script>
		const sceneEl = document.querySelector('a-scene');
		const message = document.getElementById('dom-overlay-message');

		sceneEl.addEventListener('enter-vr', function () {
			if (sceneEl.is('ar-mode')) {
				message.textContent = '';

				sceneEl.addEventListener('ar-hit-test-start', function () {
					message.innerHTML = `Scanning environment, finding surface.`
				}, { once: true });

				sceneEl.addEventListener('ar-hit-test-achieved', function () {
					message.innerHTML = `Select the location to place the furniture<br />By tapping on the screen or selecting with your controller.`
				}, { once: true });

				sceneEl.addEventListener('ar-hit-test-select', function () {
					message.textContent = '';
				}, { once: true });
			}
		});

		sceneEl.addEventListener('exit-vr', function () {
			message.textContent = '';
		});
	</script>
</body>

</html>
